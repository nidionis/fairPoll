{% extends "base.html" %}

{% block content %}
<div class="poll-detail-container">
    <h2>{{ poll.question }}</h2>

    {% if request.user == poll.author %}
    <div class="mb-4 p-3 bg-light border rounded">
        <h5>üõ†Ô∏è Administration du scrutin</h5>
        <p class="text-muted mb-2">En tant que cr√©ateur, vous devez distribuer ces cl√©s au hasard aux participants de la maison.</p>
        <a href="{% url 'poll_keys_download' poll.pk %}" class="btn btn-outline-dark">
            ‚¨áÔ∏è T√©l√©charger les cl√©s secr√®tes (.txt)
        </a>
    </div>
    {% endif %}

    <p>Utilisez les fl√®ches pour classer les propositions par ordre de pr√©f√©rence.</p>

    <!-- La liste des propositions -->
    <ul id="sortable-propositions" class="list-group mb-4">
        {% for choice in poll.choices.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ choice.id }}" style="padding: 10px; border: 1px solid #ccc; margin-bottom: 5px; background-color: #fff;">
                <span>{{ choice.text }}</span>
                
                <!-- Les boutons d'action -->
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary btn-up" title="Monter">‚¨ÜÔ∏è</button>
                    <button type="button" class="btn btn-outline-secondary btn-down" title="Descendre">‚¨áÔ∏è</button>
                </div>
            </li>
        {% empty %}
            <p>Aucune proposition pour ce scrutin.</p>
        {% endfor %}
    </ul>

    <!-- Saisie de la cl√© secr√®te -->
    <div class="mb-3">
        <label for="secret-key" class="form-label"><strong>Votre cl√© secr√®te :</strong></label>
        <input type="text" id="secret-key" class="form-control" placeholder="Entrez la cl√© de 14 caract√®res" required>
        <div id="vote-message" class="mt-2 text-danger"></div>
    </div>

    <!-- Le bouton de vote -->
    <button id="vote-btn" class="btn btn-primary">üó≥Ô∏è Voter</button>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var list = document.getElementById('sortable-propositions');

        // G√©rer les clics sur les boutons Haut / Bas
        if (list) {
            list.addEventListener('click', function(e) {
                // Trouver le bouton cliqu√© (et g√©rer le clic sur l'ic√¥ne √† l'int√©rieur)
                var btn = e.target.closest('button');
                if (!btn) return;

                var li = btn.closest('li');
                
                if (btn.classList.contains('btn-up')) {
                    // Si ce n'est pas le premier √©l√©ment, on l'ins√®re avant son grand fr√®re
                    var prev = li.previousElementSibling;
                    if (prev) {
                        list.insertBefore(li, prev);
                    }
                } 
                else if (btn.classList.contains('btn-down')) {
                    // Si ce n'est pas le dernier √©l√©ment, on l'ins√®re apr√®s son petit fr√®re
                    var next = li.nextElementSibling;
                    if (next) {
                        list.insertBefore(next, li);
                    }
                }
            });
        }

        var voteBtn = document.getElementById('vote-btn');
        if (voteBtn) {
            voteBtn.addEventListener('click', function() {
                var secretKey = document.getElementById('secret-key').value.trim();
                var messageDiv = document.getElementById('vote-message');
                messageDiv.textContent = "";
                messageDiv.className = "mt-2";

                if (!secretKey) {
                    messageDiv.textContent = "Veuillez entrer votre cl√© secr√®te.";
                    messageDiv.classList.add('text-danger');
                    return;
                }

                // R√©cup√©rer l'ordre actuel des IDs directement depuis le DOM
                var orderedIds = [];
                var items = list.querySelectorAll('li.list-group-item');
                items.forEach(function(item) {
                    orderedIds.push(item.getAttribute('data-id'));
                });
                
                // Envoi des donn√©es via Fetch API
                fetch("{% url 'poll_vote' poll.pk %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        secret_key: secretKey,
                        choices_order: orderedIds
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        messageDiv.textContent = "‚úÖ Votre vote a √©t√© enregistr√© avec succ√®s !";
                        messageDiv.className = "mt-2 text-success";
                        voteBtn.disabled = true;
                    } else {
                        messageDiv.textContent = "‚ùå Erreur : " + data.error;
                        messageDiv.className = "mt-2 text-danger";
                    }
                })
                .catch(error => {
                    messageDiv.textContent = "Une erreur de communication est survenue.";
                    messageDiv.className = "mt-2 text-danger";
                });
            });
        }
    });
</script>
{% endblock %}