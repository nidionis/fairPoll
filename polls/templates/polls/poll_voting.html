{% extends "base.html" %}

{% block content %}
<div class="poll-detail-container">
    <h2>{{ poll.question }}</h2>

    {% if request.user == poll.author %}
    <div class="mb-4 p-3 bg-light border rounded">
        <h5>üõ†Ô∏è Administration du scrutin</h5>
        <p class="text-muted mb-2">En tant que cr√©ateur, vous devez distribuer ces cl√©s au hasard aux participants de la maison.</p>
        <a href="{% url 'poll_keys_download' poll.pk %}" class="btn btn-outline-dark">
            ‚¨áÔ∏è T√©l√©charger les cl√©s secr√®tes (.txt)
        </a>
    </div>
    {% endif %}

    <p>Glissez et d√©posez les propositions pour les classer par ordre de pr√©f√©rence.</p>

    <!-- La liste des propositions -->
    <ul id="sortable-propositions" class="list-group mb-4">
        {% for choice in poll.choices.all %}
            <li class="list-group-item" data-id="{{ choice.id }}" style="cursor: grab; padding: 10px; border: 1px solid #ccc; margin-bottom: 5px; background-color: #fff;">
                ‚ò∞ {{ choice.text }}
            </li>
        {% empty %}
            <p>Aucune proposition pour ce scrutin.</p>
        {% endfor %}
    </ul>

    <!-- Saisie de la cl√© secr√®te -->
    <div class="mb-3">
        <label for="secret-key" class="form-label"><strong>Votre cl√© secr√®te :</strong></label>
        <input type="text" id="secret-key" class="form-control" placeholder="Entrez la cl√© de 14 caract√®res" required>
        <div id="vote-message" class="mt-2 text-danger"></div>
    </div>

    <!-- Le bouton de vote -->
    <button id="vote-btn" class="btn btn-primary">üó≥Ô∏è Voter</button>
</div>

<!-- Scripts pour la gestion du drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var el = document.getElementById('sortable-propositions');
        var sortable; // On d√©clare la variable ici pour la rendre accessible partout dans la fonction

        if (el) {
            sortable = Sortable.create(el, {
                animation: 150,
                ghostClass: 'bg-light',
                forceFallback: true, // Force l'utilisation du fallback JS (tr√®s utile pour Firefox)
                fallbackClass: 'sortable-fallback' // Optionnel, ajoute une classe css lors du drag
            });
        }

        var voteBtn = document.getElementById('vote-btn');
        if (voteBtn) {
            voteBtn.addEventListener('click', function() {
                var secretKey = document.getElementById('secret-key').value.trim();
                var messageDiv = document.getElementById('vote-message');
                messageDiv.textContent = "";
                messageDiv.className = "mt-2";

                if (!secretKey) {
                    messageDiv.textContent = "Veuillez entrer votre cl√© secr√®te.";
                    messageDiv.classList.add('text-danger');
                    return;
                }

                if (sortable) { // V√©rification simplifi√©e
                    var orderedIds = sortable.toArray();
                
                    fetch("{% url 'poll_vote' poll.pk %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({
                            secret_key: secretKey,
                            choices_order: orderedIds
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            messageDiv.textContent = "‚úÖ Votre vote a √©t√© enregistr√© avec succ√®s !";
                            messageDiv.className = "mt-2 text-success";
                            voteBtn.disabled = true;
                        } else {
                            messageDiv.textContent = "‚ùå Erreur : " + data.error;
                            messageDiv.className = "mt-2 text-danger";
                        }
                    })
                    .catch(error => {
                        messageDiv.textContent = "Une erreur de communication est survenue.";
                        messageDiv.className = "mt-2 text-danger";
                    });
                }
            });
        }
    });
</script>
{% endblock %}