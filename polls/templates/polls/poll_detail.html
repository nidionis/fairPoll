{% extends "base.html" %}

{% block content %}
<div class="poll-detail-container">
    <h2>{{ poll.question }}</h2>

    {% if request.user == poll.author %}
    <div class="mb-4 p-3 bg-light border rounded">
        <h5>üõ†Ô∏è Administration du scrutin</h5>
        <p class="text-muted mb-2">En tant que cr√©ateur, vous devez distribuer ces cl√©s au hasard aux participants de la maison.</p>
        <a href="{% url 'poll_keys_download' poll.pk %}" class="btn btn-outline-dark">
            ‚¨áÔ∏è T√©l√©charger les cl√©s secr√®tes (.txt)
        </a>
    </div>
    {% endif %}

    <p>Glissez et d√©posez les propositions pour les classer par ordre de pr√©f√©rence.</p>

    <!-- La liste des propositions -->
    <ul id="sortable-propositions" class="list-group mb-4">
        {% for choice in poll.choices.all %}
            <!-- L'attribut data-id est crucial pour r√©cup√©rer l'ordre -->
            <li class="list-group-item" data-id="{{ choice.id }}" style="cursor: grab; padding: 10px; border: 1px solid #ccc; margin-bottom: 5px; background-color: #fff;">
                ‚ò∞ {{ choice.text }}
            </li>
        {% empty %}
            <p>Aucune proposition pour ce scrutin.</p>
        {% endfor %}
    </ul>

    <!-- Le bouton de vote -->
    <button id="vote-btn" class="btn btn-primary">üó≥Ô∏è Voter</button>
</div>

<!-- 1. On charge la librairie directement ici -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<!-- 2. On ex√©cute notre code -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        console.log("Page charg√©e, recherche de la liste...");
        
        var el = document.getElementById('sortable-propositions');
        
        // On v√©rifie que la liste existe bien dans la page
        if (el) {
            var sortable = Sortable.create(el, {
                animation: 150,
                ghostClass: 'bg-light'
            });
            console.log("SortableJS est activ√© avec succ√®s !");
        } else {
            console.error("Erreur : La liste #sortable-propositions est introuvable.");
        }

        var voteBtn = document.getElementById('vote-btn');
        if (voteBtn) {
            voteBtn.addEventListener('click', function() {
                // On r√©cup√®re l'ordre seulement si Sortable est bien initialis√©
                if (typeof sortable !== 'undefined') {
                    var orderedIds = sortable.toArray();
                    console.log("Ordre des propositions choisi :", orderedIds);
                    alert("Regardez la console (F12) pour voir l'ordre : " + orderedIds.join(', '));
                }
            });
        }
    });
</script>
{% endblock %}