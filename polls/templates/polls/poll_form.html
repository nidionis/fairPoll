{% extends "base.html" %}

{% block content %}
<!-- Inclusion de Flatpickr pour un beau calendrier -->
<div class="poll-form-container">
    <h2>Créer un nouveau scrutin dans la maison : {{ view.house.name }}</h2>
    
    {% if form.errors %}
        <div class="alert alert-danger">
            <p>Veuillez corriger les erreurs ci-dessous :</p>
            {{ form.non_field_errors }}
            <ul>
                {% for field in form %}
                    {% if field.errors %}
                        <li><strong>{{ field.label }}</strong> : {{ field.errors|striptags }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form method="post">
        {% csrf_token %}
        <div class="mb-3">
            <div class="form-group mb-3">
                {{ form.question.label_tag }}
                <div class="text-danger">{{ form.question.errors|striptags }}</div>
                {{ form.question }}
            </div>
            
            <div class="form-group mb-3">
                {{ form.duration_value.label_tag }}
                <div class="text-danger">{{ form.duration_value.errors|striptags }}</div>
                <div class="d-flex align-items-center">
                    {{ form.duration_value }}
                    {{ form.duration_unit }}
                </div>
            </div>
            
            <div class="form-check mb-3">
                {{ form.use_tickets }}
                <label class="form-check-label" for="{{ form.use_tickets.id_for_label }}">
                    {{ form.use_tickets.label }}
                </label>
                <div class="text-danger">{{ form.use_tickets.errors|striptags }}</div>
                <small class="form-text text-muted d-block">
                    Si coché, des clés secrètes seront générées pour ce scrutin. Sinon, le vote sera validé via le compte utilisateur.
                </small>
            </div>
        </div> <!-- Ajout de la balise fermante manquante -->

        <hr>
        
        <h4>Propositions</h4>
        <div id="choices-list" class="mb-3">
            <!-- La liste des propositions déjà entrées apparaîtra ici -->
        </div>
        
        <div class="form-group mb-4 d-flex">
            <input type="text" id="new-choice-input" class="form-control me-2" placeholder="Nouvelle proposition">
            <button type="button" id="add-choice-btn" class="btn btn-outline-primary text-nowrap">+ Ajouter une proposition</button>
        </div>

        <div class="form-text mb-3">
            <small>Rappel : vous êtes limité à 7 scrutins créés par jour et l'échéance doit être située entre maintenant et d'ici 1 an.</small>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-success">✅ Soumettre le scrutin</button>
            <a href="{% url 'house-detail' view.house.pk %}" class="btn btn-secondary">Annuler</a>
        </div>
    </form>
</div>

<script>
    // Initialisation de Flatpickr pour le champ deadline
    document.addEventListener("DOMContentLoaded", function() {
        // On vérifie que flatpickr est bien défini avant de l'appeler pour éviter de planter le script
        if (typeof flatpickr !== 'undefined') {
            flatpickr(".flatpickr", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                minDate: "today", // Empêche de choisir une date dans le passé
                locale: "fr", // Calendrier en français
                time_24hr: true
            });
        } else {
            console.warn("Flatpickr n'est pas chargé sur cette page.");
        }

        // Logique pour ajouter des champs de proposition dynamiques
        const choicesList = document.getElementById('choices-list');
        const addBtn = document.getElementById('add-choice-btn');
        const newChoiceInput = document.getElementById('new-choice-input');

        function addChoice(value) {
            const trimmedValue = value.trim();
            if (!trimmedValue) return; // Ne rien ajouter si le champ est vide
            
            const div = document.createElement('div');
            div.className = 'form-group mb-2 d-flex align-items-center';
            
            // Le champ contenant la proposition validée (envoyé au backend avec name="choices")
            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'choices';
            input.className = 'form-control me-2';
            input.value = trimmedValue;
            input.readOnly = true; // On empêche la modification directe de la liste
            input.required = true;
            
            // Le bouton de suppression
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-outline-danger';
            removeBtn.textContent = '❌';
            removeBtn.onclick = function() {
                choicesList.removeChild(div);
            };
            
            div.appendChild(input);
            div.appendChild(removeBtn);
            choicesList.appendChild(div);
        }

        // Ajout via le bouton
        addBtn.addEventListener('click', function() {
            addChoice(newChoiceInput.value);
            newChoiceInput.value = ''; // On vide le champ après l'ajout
            newChoiceInput.focus();
        });

        // Ajout via la touche Entrée dans le champ de texte
        newChoiceInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Empêche la soumission accidentelle du formulaire principal
                addChoice(newChoiceInput.value);
                newChoiceInput.value = '';
            }
        });
    });
</script>
{% endblock %}